{% extends "base.html" %}

{% block content %}
<form id="cvForm" method="POST" action="{{ url_for('generate') }}" novalidate>
  <div class="steps">

    <!-- Step 1: Personal -->
    <div class="step active" data-step="1">
      <h2>1) Personal Information</h2>
      <div class="grid">
        <label>First Name<input name="first_name" required></label>
        <label>Last Name<input name="last_name" required></label>
        <label>Email<input type="email" name="email" required></label>
        <label>Phone<input name="phone"></label>
        <label class="full">Physical Address
          <input name="physical_address" placeholder="123 Main St, New York, NY 10001">
        </label>
      </div>
      <div class="nav">
        <button type="button" class="btn next">Next</button>
      </div>
    </div>

    <!-- Step 2: Education -->
    <div class="step" data-step="2">
      <h2>2) Education</h2>
      <div id="eduList" class="repeat-list"></div>
      <div class="nav">
        <button type="button" class="btn back">Back</button>
        <button type="button" class="btn next">Next</button>
      </div>
    </div>

    <!-- Step 3: Work & Leadership Experience -->
    <div class="step" data-step="3">
      <h2>3) Work & Leadership Experience</h2>
      <div id="expList" class="repeat-list"></div>
      <button type="button" class="btn ghost" onclick="addExp()">+ Add Experience</button>
      <div class="nav">
        <button type="button" class="btn back">Back</button>
        <button type="button" class="btn next">Next</button>
      </div>
    </div>

    <!-- Step 4: Skills / Footer -->
    <div class="step" data-step="4">
      <h2>4) Skills, Activities & Interests</h2>

      <div class="grid">
        <label>Languages (Fluent)<input name="languages" placeholder="English, Mandarin"></label>
        <label>Languages (Conversational)<input name="languages_secondary" placeholder="Spanish"></label>
        <label class="full">Technical Skills<input name="technical_skills" placeholder="Python, SQL, Flask"></label>
        <label class="full">Certifications & Training<input name="certifications" placeholder="CFA L1, ..."></label>
        <label class="full">Activities<input name="activities" placeholder="Student Club, Volunteer"></label>
        <label class="full">Interests<input name="interests" placeholder="Climbing, Chess"></label>
      </div>

      <div class="nav">
        <button type="button" class="btn back">Back</button>
        <button type="button" class="btn next">Next</button>
      </div>
    </div>

    <!-- Step 5: Cover Letter -->
    <div class="step" data-step="5">
      <h2>5) Cover Letter</h2>
      <div class="grid">
        <label>Recruiter Name<input name="recruiter_name"></label>
        <label>Recruiter Title<input name="recruiter_title"></label>
        <label>Recruiter Salutation (Mr./Ms./Dr.)<input name="recruiter_salutation"></label>
        <label>Company Name<input name="company_name"></label>
        <label class="full">Recruiter’s Address<input name="recruiter_address" placeholder="Street, City, State, Zip"></label>

        <label>Your School Year (e.g., Sophomore, 1st-year MBA)<input name="cl_year"></label>
        <!-- School Name & Major removed here (we will use Education step values) -->

        <label >Where did you hear about the company?<input name="referral_source" ></label>
        <label >What impressed you most about the company?<input name="firm_impression"></label>
        <label>The position you applied for<input name="position_name" placeholder="Investment Banking Analyst"></label>

        <label class="full">Past Experience<textarea name="past_experience" placeholder="Completed Internships In… / Worked Full-Time In…"></textarea></label>
        <label class="full">Experience Theme<textarea name="experience_theme" placeholder="Working on Transactions / Leading Teams and Managing Projects / Performing Quantitative Analysis"></textarea></label>
        <label class="full">Gained Skills<textarea name="gained_skills" placeholder="Go Into Anything Relevant to Banking, Such As Analytical / Leadership / Teamwork / Finance / Accounting"></textarea></label>
        <label class="full">Other Skills<textarea name="other_skills" placeholder="Any Other Relevant Skills honed by the experience"></textarea></label>

        <label>Representative Project<input name="project" placeholder="High-Impact Project"></label>
        <label class="full">Project Result<textarea name="project_result"  placeholder="Describe Results"></textarea></label>

        <label class="full">Background Summary<textarea name="background_summary" placeholder="Summarize Internships / Work Experience"></textarea></label>
        <label class="full">Skill Summary<textarea name="skill_summary" placeholder="Summarize Skills"></textarea></label>
        <label class="full">Firm Track Record<textarea name="firm_track_record" placeholder="Transactions / Clients"></textarea></label>
        <label>Signature (optional text)<input name="signature"></label>
      </div>

      <div class="nav">
        <button type="button" class="btn back">Back</button>
        <button type="submit"
        class="btn primary"
        formaction="{{ url_for('preview') }}"
        formtarget="_blank">Generate DOCX/PDF</button>

      </div>
    </div>

  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// step navigation
const steps = [...document.querySelectorAll(".step")];
let cur = 0;
function updateStep(n) {
  steps[cur].classList.remove("active");
  cur = Math.max(0, Math.min(steps.length - 1, n));
  steps[cur].classList.add("active");
  window.scrollTo({ top: 0, behavior: "smooth" });
}
document.querySelectorAll(".next").forEach(b => b.addEventListener("click", () => updateStep(cur+1)));
document.querySelectorAll(".back").forEach(b => b.addEventListener("click", () => updateStep(cur-1)));

function makeRow(html) {
  const wrap = document.createElement("div");
  wrap.className = "repeat-item";
  wrap.innerHTML = html + '<button type="button" class="icon-btn remove" title="Remove" onclick="this.parentElement.remove()">✕</button>';
  return wrap;
}
function vals(name){ return [...document.querySelectorAll(`[name="${name}"]`)].map(e => e.value.trim()); }
function collectGroup(prefix, fields) {
  const lists = {};
  fields.forEach(f => lists[f] = vals(`${prefix}_${f}[]`));
  const length = Math.max(...fields.map(f => lists[f].length), 0);
  const items = [];
  for (let i=0;i<length;i++){
    const it = {};
    fields.forEach(f => it[f] = (lists[f][i]||"").trim());
    if (Object.values(it).some(v => v)) items.push(it);
  }
  return items;
}

// Education row (degree type dropdown, SAT vs non-US, NO ed_desc)
function addEdu() {
  const html = `
    <div class="grid">
      <label>School<input name="ed_school[]"></label>
      <label>City<input name="ed_city[]"></label>
      <label>State/Province<input name="ed_state[]"></label>
      <label>Country<input name="ed_country[]"></label>

      <label>Degree Type
        <select name="ed_degree_type[]">
          <option value="">Select…</option>
          <option value="Arts">Arts</option>
          <option value="Science">Science</option>
        </select>
      </label>
      <label>Major<input name="ed_field[]"></label>
      <label>Start<input name="ed_start[]" placeholder="YYYY/MM"></label>
      <label>End / Graduation<input name="ed_end[]" placeholder="YYYY/MM or Present"></label>

      <label>GPA (US 4.0)<input name="ed_gpa[]" placeholder="3.8"></label>
      <label>SAT<input name="ed_sat[]" placeholder="1500"></label>
      <label class="full">Non‑US Grade System
        <input name="ed_grade_system[]" placeholder="First Class (70/100), UK">
      </label>

      <label class="full">Honors<input name="ed_honors[]"></label>
      <label class="full">Relevant Coursework<input name="ed_courses[]"></label>
    </div>`;
  document.getElementById("eduList").appendChild(makeRow(html));
}

// Experience row (unlimited, reuse first template; Group optional)
function addExp() {
  const html = `
    <div class="grid">
      <label>Company<input name="e_company[]"></label>
      <label>City<input name="e_city[]"></label>
      <label>State/Province<input name="e_state[]"></label>
      <label>Country<input name="e_country[]"></label>

      <label>Title<input name="e_title[]"></label>
      <label>Group (optional)<input name="e_group[]"></label>
      <label>Start<input name="e_start[]" placeholder="YYYY/MM"></label>
      <label>End<input name="e_end[]" placeholder="YYYY/MM or Present"></label>

      <label class="full">Experience Description<textarea name="e_summary[]" rows="3"></textarea></label>
    </div>`;
  document.getElementById("expList").appendChild(makeRow(html));
}

// init one row
addEdu();
addExp();

// Review includes EVERYTHING (CV + CL)
function buildReview() {
  const fn = document.querySelector('[name="first_name"]').value.trim();
  const ln = document.querySelector('[name="last_name"]').value.trim();
  const email = document.querySelector('[name="email"]').value.trim();
  const phone = document.querySelector('[name="phone"]').value.trim();
  const physical = document.querySelector('[name="physical_address"]').value.trim();

  const eds = collectGroup("ed", ["school","city","state","country","degree_type","field","start","end","gpa","sat","grade_system","honors","courses"]);
  const exps = collectGroup("e", ["company","city","state","country","title","group","start","end","summary"]);

  const languages = document.querySelector('[name="languages"]').value.trim();
  const languages_secondary = document.querySelector('[name="languages_secondary"]').value.trim();
  const technical = document.querySelector('[name="technical_skills"]').value.trim();
  const certs = document.querySelector('[name="certifications"]').value.trim();
  const acts = document.querySelector('[name="activities"]').value.trim();
  const inters = document.querySelector('[name="interests"]').value.trim();

  const recruiter_name = document.querySelector('[name="recruiter_name"]').value.trim();
  const recruiter_title = document.querySelector('[name="recruiter_title"]').value.trim();
  const recruiter_salutation = document.querySelector('[name="recruiter_salutation"]').value.trim();
  const recruiter_last_name = recruiter_name ? recruiter_name.trim().split(/\s+/).slice(-1)[0] : "";
  const company_name = document.querySelector('[name="company_name"]').value.trim();
  const recruiter_address = document.querySelector('[name="recruiter_address"]').value.trim();
  const cl_year = document.querySelector('[name="cl_year"]').value.trim();
  const referral_source = document.querySelector('[name="referral_source"]').value.trim();
  const firm_impression = document.querySelector('[name="firm_impression"]').value.trim();
  const position_name = document.querySelector('[name="position_name"]').value.trim();
  const past_experience = document.querySelector('[name="past_experience"]').value.trim();
  const experience_theme = document.querySelector('[name="experience_theme"]').value.trim();
  const gained_skills = document.querySelector('[name="gained_skills"]').value.trim();
  const other_skills = document.querySelector('[name="other_skills"]').value.trim();
  const project = document.querySelector('[name="project"]').value.trim();
  const project_result = document.querySelector('[name="project_result"]').value.trim();
  const background_summary = document.querySelector('[name="background_summary"]').value.trim();
  const skill_summary = document.querySelector('[name="skill_summary"]').value.trim();
  const firm_track_record = document.querySelector('[name="firm_track_record"]').value.trim();
  const signature = document.querySelector('[name="signature"]').value.trim();

  const html = `
    <h3>CV Preview</h3>
    <p><b>${fn || "Firstname"} ${ln || "Surname"}</b></p>
    <p>${[physical, phone, email].filter(Boolean).join(" · ")}</p>
    <hr>
    <h4>Education</h4>
    ${eds.map(e => `<div class="row">
      <b>Bachelor of ${e.degree_type||""} in ${e.field||""}</b> — ${e.school||""} (${e.start||""} – ${e.end||""})<br>
      ${[e.city, e.state, e.country].filter(Boolean).join(", ")}<br>
      ${e.gpa ? ("GPA: "+e.gpa) : ""} ${e.sat ? ("; SAT: "+e.sat) : (e.grade_system ? ("; "+e.grade_system) : "")}<br>
      ${e.honors?("Honors: "+e.honors):""} ${e.courses?("<br>Relevant Coursework: "+e.courses):""}
    </div>`).join("")}

    <h4>Experience</h4>
    ${exps.map(x => `<div class="row">
      <b>${x.title||""}${x.group?(", "+x.group):""}</b> — ${x.company||""} (${x.start||""} – ${x.end||""})<br>
      ${[x.city, x.state, x.country].filter(Boolean).join(", ")}<br>
      ${(x.summary||"").replace(/\\n/g,"<br>")}
    </div>`).join("<br>")}

    <h4>Skills, Activities & Interests</h4>
    <div>Languages: Fluent in ${languages||""}; Conversational Proficiency in ${languages_secondary||""}</div>
    ${technical?("<div>Technical Skills: "+technical+"</div>"):""}
    ${certs?("<div>Certifications & Training: "+certs+"</div>"):""}
    ${acts?("<div>Activities: "+acts+"</div>"):""}
    ${inters?("<div>Interests: "+inters+"</div>"):""}

    <h3>Cover Letter Preview</h3>
    <p><b>${fn || "Firstname"} ${ln || "Surname"}</b></p>
    <p>${[physical, phone, email].filter(Boolean).join(" · ")}</p>
    <div>Date: ${new Date().toLocaleDateString()}</div>
    <div>${recruiter_name||""} — ${recruiter_title||""}</div>
    <div>${company_name||""}</div>
    <div>${recruiter_address||""}</div>
    <br>
    <div>Salutation: ${recruiter_salutation||"Mr./Ms."} ${recruiter_last_name||""}</div>
    <div>Year: ${cl_year||""}; School: ${eds[0]?.school || ""}; Major: ${eds[0]?.field || ""}</div>
    <div>Where did you hear about the company?: ${referral_source||""}</div>
    <div>What impressed you most about the company?: ${firm_impression||""}</div>
    <div>Position Name: ${position_name||""}</div>
    <div>Past Experience: ${past_experience||""}</div>
    <div>Experience Theme: ${experience_theme||""}</div>
    <div>Gained Skills: ${gained_skills||""}</div>
    <div>Other Skills: ${other_skills||""}</div>
    <div>Representative Project: ${project||""}</div>
    <div>Project Result: ${project_result||""}</div>
    <div>Background Summary: ${background_summary||""}</div>
    <div>Skill Summary: ${skill_summary||""}</div>
    <div>Firm Track Record: ${firm_track_record||""}</div>
    <div>Signature: ${signature||""}</div>
  `;
  const box = document.getElementById("reviewBox");
  if (box) box.innerHTML = html;
}
</script>
{% endblock %}
